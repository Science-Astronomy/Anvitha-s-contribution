<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FlightTracker ‚Ä¢ Carbon Impact Monitor</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f1f8f4;
      --panel: #ffffff;
      --ink: #0f172a;
      --muted: #64748b;
      --line: #e2e8f0;
      --blue: #2563eb;
      --red: #ef4444;
      --purple: #7c3aed;
      --green: #16a34a;
      --shadow: 0 10px 20px rgba(2, 6, 23, 0.06),
        0 2px 6px rgba(2, 6, 23, 0.04);
    }
    body { margin: 0; font-family: Inter, system-ui, sans-serif; color: var(--ink); background: var(--bg); display: flex; height: 100%; }
    .sidebar { width: 250px; min-height: 100vh; background: #fff; border-right: 1px solid var(--line); display: flex; flex-direction: column; justify-content: space-between; padding: 18px 14px; }
    .main { flex: 1; padding: 24px; overflow: auto; }
    .brand { display: flex; gap: 12px; align-items: center; }
    .brand-icon { width: 40px; height: 40px; display: grid; place-items: center; background: #e6f6ea; border-radius: 12px; }
    .brand-title { font-weight: 700; }
    .brand-sub { font-size: 0.85rem; color: var(--muted); }
    .auth-controls { margin-top: 16px; display: grid; gap: 8px; }
    .auth-controls .badge { justify-self: start; background: #dcfce7; color: #14532d; }
    .nav { display: flex; flex-direction: column; gap: 8px; margin-top: 18px; }
    .nav-item, .btn { cursor: pointer; border: none; border-radius: 12px; padding: 10px 12px; font-weight: 600; }
    .nav-item { display: flex; gap: 10px; text-decoration: none; color: var(--ink); }
    .nav-item.active { background: #e8fff0; color: #166534; }
    .btn-ghost { background: #eef2ff; color: #4338ca; }
    .sidebar-cta { margin-top: auto; display: grid; gap: 8px; place-items: center; padding: 14px; border: 1px dashed #94a3b8; border-radius: 14px; background: #ecfdf5; }
    .page-header h1 { margin: 0 0 4px; font-size: 2rem; color: #166534; }

    .kpi-grid { margin-top: 18px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .kpi { background: var(--panel); border-radius: 18px; padding: 14px; box-shadow: var(--shadow); }
    .kpi-value { font-size: 28px; font-weight: 700; color: #fff; }
    .kpi-blue { background: linear-gradient(135deg, #1d4ed8, #60a5fa); }
    .kpi-red { background: linear-gradient(135deg, #dc2626, #fb7185); }
    .kpi-purple { background: linear-gradient(135deg, #7c3aed, #a78bfa); }
    .kpi-green { background: linear-gradient(135deg, #16a34a, #34d399); }

    .content-grid { margin-top: 18px; display: grid; grid-template-columns: 2fr 1fr; gap: 18px; }
    .card { background: var(--panel); border: 1px solid var(--line); border-radius: 16px; box-shadow: var(--shadow); padding: 16px; }

    .flight-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 12px; }
    .flight { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; padding: 12px; border: 1px solid var(--line); border-radius: 14px; background: #f8fafc; }
    .badge { font-size: 0.75rem; padding: 2px 8px; border-radius: 999px; background: #e2e8f0; }
    .tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 999px; background: #ecfeff; color: #0891b2; margin-left: 6px; }
    .dim { color: var(--muted); }
    .hidden { display: none; }

    .form-grid { display: grid; gap: 12px; }
    .form-grid input, .form-grid select { padding: 8px; border: 1px solid var(--line); border-radius: 8px; }
    .btn-green { background: linear-gradient(135deg, #16a34a, #34d399); color: #fff; }

    .persp-box { display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; background: #f0fdf4; padding: 12px; border-radius: 12px; }
    .persp-box div:last-child { font-weight: 700; color: #14532d; }

    .impact-card { background: linear-gradient(135deg,#16a34a,#60d394); color:#052e16; border:none; margin-top:12px;}
    .impact-title{display:flex;align-items:center;gap:8px;font-weight:700}
    .impact-grid{margin-top:8px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .impact-item{background:rgba(255,255,255,.25);border-radius:12px;padding:12px}
    .impact-value{font-size:22px;font-weight:800}
    .impact-label{font-size:12px;opacity:.9}
    .share-toolbar { margin: 16px 0; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

    /* üéÆ Games footer buttons */
    .games-footer { text-align:center; margin-top: 28px; }
    .game-btn {
      display:inline-block; margin:10px; padding:10px 14px;
      border-radius:12px; background:linear-gradient(135deg,#2563eb,#60a5fa);
      color:#fff; font-weight:600; text-decoration:none; box-shadow:var(--shadow);
    }
    .game-btn:hover { opacity:0.9; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div>
      <div class="brand">
        <div class="brand-icon">‚úàÔ∏è</div>
        <div>
          <div class="brand-title">FlightTracker</div>
          <div class="brand-sub">Carbon Impact Monitor</div>
        </div>
      </div>
      <div class="auth-controls">
        <span id="userBadge" class="badge">Guest</span>
        <button id="loginBtn" class="btn btn-green">Sign in with Google</button>
        <button id="logoutBtn" class="btn btn-ghost hidden">Sign out</button>
      </div>
      <nav class="nav">
        <a id="dashboardLink" class="nav-item active" href="#">Dashboard</a>
        <button id="addFlightBtn" class="btn btn-ghost">Ôºã Add Flight</button>
      </nav>
    </div>
    <div class="sidebar-cta">üå± Reduce Your Carbon Footprint</div>
  </aside>

  <!-- Main -->
  <main class="main">
    <!-- Dashboard -->
    <section id="dashboardSection">
      <header class="page-header"><h1>Flight Dashboard</h1></header>
      <div class="share-toolbar">
        <button id="shareBtn" class="btn btn-green">Share Impact</button>
        <span class="dim">Share totals only‚Äîyour flight details stay private.</span>
      </div>
      <section class="kpi-grid">
        <div class="kpi kpi-blue"><div class="kpi-value" id="kpiFlights">0</div><div>Total Flights</div></div>
        <div class="kpi kpi-red"><div class="kpi-value" id="kpiCO2">0 kg</div><div>Total CO‚ÇÇ</div></div>
        <div class="kpi kpi-purple"><div class="kpi-value" id="kpiKm">0 km</div><div>Distance</div></div>
        <div class="kpi kpi-green"><div class="kpi-value" id="kpiTrees">0</div><div>Trees</div></div>
      </section>
      <section class="content-grid">
        <div class="card"><canvas id="co2Chart"></canvas></div>
        <div class="card"><div class="card-title">Recent Flights</div><ul id="recentFlights" class="flight-list"></ul></div>
      </section>

      <!-- üéÆ Two game buttons at the very bottom -->
      <div class="games-footer">
        <h3>üéÆ Play Games</h3>
        <a href="https://frolicking-figolla-f0826a.netlify.app/" target="_blank" class="game-btn">Zoomy</a>
        <a href="https://spoopygamer.netlify.app/" target="_blank" class="game-btn">Choices Choices</a>
      </div>
    </section>

    <!-- Add Flight -->
    <section id="addFlightSection" class="hidden">
      <header class="page-header"><h1>Add New Flight</h1></header>
      <section class="content-grid">
        <div class="card">
          <form id="addFlightForm" class="form-grid">
            <label>From 
              <input type="text" name="from" placeholder="IATA/ICAO or @lat,lon" required />
            </label>
            <label>To 
              <input type="text" name="to" placeholder="IATA/ICAO or @lat,lon" required />
            </label>
            <label>Date <input type="date" name="date" required /></label>
            <label>Airline <input type="text" name="airline" /></label>
            <label>Code <input type="text" name="code" /></label>
            <label>Aircraft
              <select name="aircraft">
                <option value="narrow">Narrow</option>
                <option value="wide">Wide</option>
              </select>
            </label>
            <label>Cabin
              <select name="cabin">
                <option value="economy">Economy</option>
                <option value="business">Business</option>
                <option value="first">First</option>
              </select>
            </label>
            <button type="submit" class="btn-green">Add Flight</button>
          </form>
        </div>

        <div class="card">
          <div>üìä Emission Estimate</div>
          <p id="estimateCO2">0 kg</p>
          <p id="estimateMeta">Distance: 0 km ‚Ä¢ Trees: 0</p>
        </div>

        <div class="card">
          <div>Put It In Perspective</div>
          <div class="persp-box"> üöó <div>Car equivalent</div><div><span id="perspCar">0</span> km</div></div>
          <div class="persp-box"> üå≤ <div>Trees needed</div><div><span id="perspTrees">0</span></div></div>
          <div class="persp-box"> üè† <div>Home energy</div><div><span id="perspEnergy">0</span> months</div></div>
        </div>

        <div class="card impact-card">
          <div class="impact-title">üå≤ Environmental Impact</div>
          <div class="impact-grid">
            <div class="impact-item"><div class="impact-value" id="impactTotalCo2">0</div><div class="impact-label">kg CO‚ÇÇ</div></div>
            <div class="impact-item"><div class="impact-value" id="impactTrees">0</div><div class="impact-label">trees</div></div>
            <div class="impact-item"><div class="impact-value" id="impactAvg">0</div><div class="impact-label">avg/flight</div></div>
          </div>
          <div class="hint" id="impactHint">Includes saved flights.</div>
        </div>
      </section>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js';
    import {
      getAuth,
      GoogleAuthProvider,
      onAuthStateChanged,
      signInWithPopup,
      signOut
    } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js';
    import {
      collection,
      doc,
      getDocs,
      getFirestore,
      limit,
      orderBy,
      query,
      serverTimestamp,
      setDoc
    } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js';

    // ===== DOM references =====
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userBadge = document.getElementById('userBadge');
    const shareBtn = document.getElementById('shareBtn');
    const dashboardLink = document.getElementById('dashboardLink');
    const addFlightBtn = document.getElementById('addFlightBtn');
    const dash = document.getElementById('dashboardSection');
    const add = document.getElementById('addFlightSection');
    const form = document.getElementById('addFlightForm');

    // ===== Firebase bootstrap =====
    const firebaseConfig = {
      apiKey: 'AIzaSyAsJR5Sv9T6Jfk7QIl8x1NJ-kVYnoMPHNE',
      authDomain: 'flight-tracker-406c7.firebaseapp.com',
      projectId: 'flight-tracker-406c7',
      storageBucket: 'flight-tracker-406c7.firebasestorage.app',
      messagingSenderId: '1011985254671',
      appId: '1:1011985254671:web:1fd11778bebfe17a05967a'
    };

    const firebaseConfigReady = Object.values(firebaseConfig).every(value => Boolean(value));
    let app, auth, db;

    if (firebaseConfigReady) {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
    } else {
      console.warn('Firebase config missing. Sign-in features stay disabled until you add real keys.');
    }

    // ===== Airport DB =====
    const IATA_MAP = new Map();
    const ICAO_MAP = new Map();
    const CITY_MAP = new Map();

    async function loadAirports() {
      try {
        const resp = await fetch('https://cdn.jsdelivr.net/gh/mwgg/Airports/airports.json');
        const data = await resp.json();
        for (const icao in data) {
          const record = data[icao];
          const lat = Number(record.lat);
          const lon = Number(record.lon);
          if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;

          ICAO_MAP.set(icao.toUpperCase(), [lat, lon]);
          if (record.iata) IATA_MAP.set(record.iata.toUpperCase(), [lat, lon]);
          if (record.city) CITY_MAP.set(record.city.toUpperCase(), [lat, lon]);
        }
      } catch (error) {
        console.error('Airport DB load failed', error);
      }
    }
    loadAirports();

    function lookupAirport(token) {
      if (!token) return null;
      const upper = token.trim().toUpperCase();
      if (upper.startsWith('@')) {
        const [lat, lon] = upper.slice(1).split(',');
        return [parseFloat(lat), parseFloat(lon)];
      }
      if (CITY_MAP.has(upper)) return CITY_MAP.get(upper);
      if (IATA_MAP.has(upper)) return IATA_MAP.get(upper);
      if (ICAO_MAP.has(upper)) return ICAO_MAP.get(upper);
      console.warn('Unknown airport:', token);
      return null;
    }

    const EARTH_RADIUS_KM = 6371;
    const toRad = degrees => degrees * Math.PI / 180;
    const haversine = (a, b) => {
      return 2 * EARTH_RADIUS_KM * Math.asin(Math.sqrt(
        Math.sin((toRad(b[0] - a[0])) / 2) ** 2 +
        Math.cos(toRad(a[0])) * Math.cos(toRad(b[0])) *
        Math.sin((toRad(b[1] - a[1])) / 2) ** 2
      ));
    };

    // ===== Demo data =====
    const demoFlights = [
      { airline: 'British Airways', code: 'BA112', from: 'New York', to: 'London', when: 'Dec 14, 2024', dateISO: '2024-12-14', km: 5585, cabin: 'economy', co2kg: 1089, type: 'long haul' },
      { airline: 'Air France', code: 'AF1234', from: 'Paris', to: 'Madrid', when: 'Nov 30, 2024', dateISO: '2024-11-30', km: 1050, cabin: 'economy', co2kg: 210, type: 'short haul' },
      { airline: 'United Airlines', code: 'UA415', from: 'San Francisco', to: 'Seattle', when: 'Nov 22, 2024', dateISO: '2024-11-22', km: 1091, cabin: 'economy', co2kg: 196, type: 'short haul' }
    ];
    const monthly = { labels: ['Sep 2024', 'Oct 2024', 'Nov 2024', 'Dec 2024'], co2kg: [900, 2100, 4800, 1300] };
    let currentFlights = [...demoFlights];

    const co2Chart = new Chart(document.getElementById('co2Chart'), {
      type: 'bar',
      data: { labels: monthly.labels, datasets: [{ label: 'CO‚ÇÇ (kg)', data: monthly.co2kg, borderRadius: 10 }] },
      options: { plugins: { legend: { display: false } } }
    });

    // ===== Rendering helpers =====
    function summariseFlights(flights) {
      return flights.reduce((acc, flight) => {
        acc.totalFlights += 1;
        acc.totalCo2 += Number(flight.co2kg || 0);
        acc.totalKm += Number(flight.km || 0);
        return acc;
      }, { totalFlights: 0, totalCo2: 0, totalKm: 0 });
    }

    // Aggregate flights by month-year and return ordered labels/data
    function getMonthlyCo2(flights) {
      const map = new Map();
      flights.forEach(r => {
        const d = r.dateISO ? new Date(r.dateISO) : new Date(r.when);
        if (isNaN(d)) return;
        const key = `${d.getFullYear()}-${d.getMonth()}`;
        if (!map.has(key)) {
          map.set(key, {
            label: d.toLocaleString(undefined, { month: 'short', year: 'numeric' }),
            sum: 0,
            ts: new Date(d.getFullYear(), d.getMonth(), 1).getTime()
          });
        }
        map.get(key).sum += (r.co2kg || 0);
      });
      const arr = Array.from(map.values()).sort((a,b)=>a.ts - b.ts);
      return { labels: arr.map(x=>x.label), data: arr.map(x=>x.sum) };
    }

    function updateChart() {
      const { labels, data } = getMonthlyCo2(currentFlights);
      co2Chart.data.labels = labels.length ? labels : monthly.labels;
      co2Chart.data.datasets[0].data = data.length ? data : monthly.co2kg;
      co2Chart.update();
    }

    function renderKpis(flights = currentFlights) {
      const summary = summariseFlights(flights);
      document.getElementById('kpiFlights').textContent = summary.totalFlights;
      document.getElementById('kpiCO2').textContent = `${Math.round(summary.totalCo2)} kg`;
      document.getElementById('kpiKm').textContent = `${Math.round(summary.totalKm)} km`;
      document.getElementById('kpiTrees').textContent = Math.round(summary.totalCo2 / 22);
    }

    function renderList(flights = currentFlights) {
      const list = document.getElementById('recentFlights');
      if (!list) return;
      if (!flights.length) {
        list.innerHTML = '<li class="flight dim">No flights yet. Add one to see it here!</li>';
        return;
      }
      list.innerHTML = flights.map(flight => `
        <li class="flight">
          <div>‚úàÔ∏è</div>
          <div>
            <div><strong>${flight.airline}</strong> <span class="badge">${flight.code}</span> <span class="tag">${flight.cabin}</span></div>
            <div class="dim">${flight.from} ‚Üí ${flight.to} ‚Ä¢ ${flight.when}</div>
            <div class="dim">${flight.km} km ‚Ä¢ ${flight.type}</div>
          </div>
          <div><div class="badge">${flight.co2kg} kg CO‚ÇÇ</div></div>
        </li>`).join('');
    }

    function updateImpactPanel(flights = currentFlights, { previewFlight } = {}) {
      const base = Array.isArray(flights) ? [...flights] : [];
      const combined = previewFlight ? [previewFlight, ...base] : base;
      const summary = summariseFlights(combined);
      const flightsCount = summary.totalFlights;
      const totalCo2 = Math.round(summary.totalCo2);
      document.getElementById('impactTotalCo2').textContent = totalCo2;
      document.getElementById('impactTrees').textContent = Math.round(totalCo2 / 22);
      document.getElementById('impactAvg').textContent = flightsCount ? Math.round(totalCo2 / flightsCount) : 0;
      const hint = previewFlight ? 'Includes saved flights + this entry.' : (flightsCount ? 'Includes saved flights.' : 'No flights saved yet.');
      document.getElementById('impactHint').textContent = hint;
    }

    function updateUiWithFlights(flights) {
      currentFlights = Array.isArray(flights) ? [...flights] : [];
      renderKpis();
      renderList();
      updateImpactPanel();
      updateChart();
    }

    function getCurrentFlights() {
      return [...currentFlights];
    }

    function resetToDemoData() {
      updateUiWithFlights(demoFlights);
    }

    // ===== Distance + estimate helpers =====
    function computeKm() {
      const fromCoords = lookupAirport(form.from.value);
      const toCoords = lookupAirport(form.to.value);
      if (!fromCoords || !toCoords) return 0;
      return Math.round(haversine(fromCoords, toCoords));
    }

    function estimate() {
      const km = computeKm();
      const cabin = form.cabin.value;
      const aircraft = form.aircraft.value;
      let factor = 0.18;
      if (aircraft === 'wide') factor *= 1.05;
      if (cabin === 'business') factor *= 2;
      if (cabin === 'first') factor *= 3;
      const co2 = Math.round(km * factor);
      const trees = Math.round(co2 / 22);

      document.getElementById('estimateCO2').textContent = `${co2} kg`;
      document.getElementById('estimateMeta').textContent = `Distance: ${km} km ‚Ä¢ Trees: ${trees}`;
      document.getElementById('perspCar').textContent = Math.round(co2 / 0.12);
      document.getElementById('perspTrees').textContent = trees;
      document.getElementById('perspEnergy').textContent = Math.round(co2 / 300);

      updateImpactPanel(currentFlights, {
        previewFlight: km ? { co2kg: co2, km } : null
      });

      return { km, co2 };
    }

    function resetEstimateUI() {
      document.getElementById('estimateCO2').textContent = '0 kg';
      document.getElementById('estimateMeta').textContent = 'Distance: 0 km ‚Ä¢ Trees: 0';
      document.getElementById('perspCar').textContent = '0';
      document.getElementById('perspTrees').textContent = '0';
      document.getElementById('perspEnergy').textContent = '0';
      updateImpactPanel(currentFlights);
    }

    ['input', 'change'].forEach(eventName => {
      ['from', 'to', 'cabin', 'aircraft'].forEach(field => {
        form[field].addEventListener(eventName, estimate);
      });
    });

    async function saveFlight(uid, flight) {
      if (!db) return;
      const flightsRef = collection(db, 'users', uid, 'flights');
      const docId = `${Date.now()}`;
      await setDoc(doc(flightsRef, docId), {
        ...flight,
        createdAt: serverTimestamp()
      });
    }

    async function loadFlights(uid) {
      if (!db) {
        resetToDemoData();
        return;
      }
      const flightsRef = collection(db, 'users', uid, 'flights');
      const q = query(flightsRef, orderBy('createdAt', 'desc'), limit(50));
      const snapshot = await getDocs(q);
      const flights = snapshot.docs.map(docSnap => {
        const data = docSnap.data();
        return {
          ...data,
          when: data.when || 'Unknown date',
          co2kg: Math.round(data.co2kg || 0),
          km: Math.round(data.km || 0)
        };
      });
      updateUiWithFlights(flights);
    }

    async function handleFormSubmit(event) {
      event.preventDefault();
      const { km, co2 } = estimate();
      if (!km) {
        alert('Could not calculate distance. Please check your From/To inputs.');
        return;
      }

      const [year, month, day] = form.date.value.split('-');
      const formattedDate = new Date(year, month - 1, day).toLocaleDateString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });

      const flightRecord = {
        airline: form.airline.value || 'Airline',
        code: (form.code.value || 'NEW').toUpperCase(),
        from: form.from.value,
        to: form.to.value,
        when: formattedDate,
        dateISO: form.date.value,
        km,
        co2kg: co2,
        cabin: form.cabin.value,
        type: km > 3500 ? 'long haul' : 'short haul'
      };

      if (auth && auth.currentUser) {
        await saveFlight(auth.currentUser.uid, flightRecord);
        await loadFlights(auth.currentUser.uid);
      } else {
        demoFlights.unshift(flightRecord);
        updateUiWithFlights(demoFlights);
      }

      dash.classList.remove('hidden');
      add.classList.add('hidden');
      form.reset();
      resetEstimateUI();
    }

    form.addEventListener('submit', handleFormSubmit);

    addFlightBtn.addEventListener('click', () => {
      dash.classList.add('hidden');
      add.classList.remove('hidden');
    });

    dashboardLink.addEventListener('click', event => {
      event.preventDefault();
      add.classList.add('hidden');
      dash.classList.remove('hidden');
    });

    if (loginBtn) {
      loginBtn.addEventListener('click', async () => {
        if (!firebaseConfigReady || !auth) {
          alert('Add your Firebase config in index.html before enabling Google sign-in.');
          return;
        }
        try {
          await signInWithPopup(auth, new GoogleAuthProvider());
        } catch (error) {
          alert(`Login failed: ${error.message}`);
        }
      });
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        if (!auth) return;
        await signOut(auth);
      });
    }

    if (firebaseConfigReady && auth) {
      onAuthStateChanged(auth, user => {
        if (user) {
          loginBtn.classList.add('hidden');
          logoutBtn.classList.remove('hidden');
          userBadge.textContent = user.displayName || user.email;
          loadFlights(user.uid);
        } else {
          loginBtn.classList.remove('hidden');
          logoutBtn.classList.add('hidden');
          userBadge.textContent = 'Guest';
          resetToDemoData();
        }
      });
    } else {
      loginBtn.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      userBadge.textContent = 'Guest';
      resetToDemoData();
    }

    if (shareBtn) {
      shareBtn.addEventListener('click', async () => {
        const flights = getCurrentFlights();
        const summary = summariseFlights(flights);
        const trees = Math.round(summary.totalCo2 / 22);
        const shareText = `I tracked ${summary.totalFlights} flights offsetting ${trees} trees worth of CO‚ÇÇ!`;

        if (navigator.share) {
          try {
            await navigator.share({
              title: 'My FlightTracker Impact',
              text: shareText,
              url: window.location.origin
            });
          } catch (error) {
            alert('Share canceled or failed. Try again.');
          }
        } else {
          try {
            await navigator.clipboard.writeText(`${shareText}\nVisit: ${window.location.href}`);
            alert('Share text copied‚Äîpaste it anywhere!');
          } catch (error) {
            alert('Copy failed. Press ‚åò+C / Ctrl+C to share manually.');
          }
        }
      });
    }

    // ===== Init =====
    resetToDemoData();
    estimate();
    updateChart();
  </script>
</body>
</html>
